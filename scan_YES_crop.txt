import os
import cv2
import numpy as np
import tensorflow as tf
import shutil
import imutils
from tqdm import tqdm

# --- 1. C·∫§U H√åNH ---
FOLDER_YES = '/content/drive/MyDrive/image/yes'      # Folder ch·ª©a ·∫£nh C√ì U
# ƒê·ªïi t√™n file model th√†nh file m·ªõi nh·∫•t b·∫°n v·ª´a train
MODEL_PATH = '/content/drive/MyDrive/image/brain_tumor_PRO.h5' 
OUTPUT_FOLDER = '/content/drive/MyDrive/image/ket_qua_sai_yes_pro'   # L∆∞u ra folder m·ªõi ƒë·ªÉ d·ªÖ so s√°nh
THRESHOLD = 0.5  # Ng∆∞·ª°ng (D∆∞·ªõi m·ª©c n√†y l√† AI ph√°n KH√îNG b·ªánh/B·ªè s√≥t)

# --- 2. H√ÄM X·ª¨ L√ù ·∫¢NH CAO C·∫§P (Copy y nguy√™n t·ª´ l√∫c train) ---
def ham_xu_ly_xin(img):
    if img.dtype != 'uint8':
        img = np.array(img, dtype=np.uint8)

    # 1. C·∫Øt x∆∞∆°ng s·ªç
    gray = cv2.cvtColor(img, cv2.COLOR_RGB2GRAY) 
    gray = cv2.GaussianBlur(gray, (5, 5), 0)
    thresh = cv2.threshold(gray, 45, 255, cv2.THRESH_BINARY)[1]
    thresh = cv2.erode(thresh, None, iterations=2)
    thresh = cv2.dilate(thresh, None, iterations=2)
    
    cnts = cv2.findContours(thresh.copy(), cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
    cnts = imutils.grab_contours(cnts)
    
    if len(cnts) > 0:
        c = max(cnts, key=cv2.contourArea)
        extLeft = tuple(c[c[:, :, 0].argmin()][0])
        extRight = tuple(c[c[:, :, 0].argmax()][0])
        extTop = tuple(c[c[:, :, 1].argmin()][0])
        extBot = tuple(c[c[:, :, 1].argmax()][0])
        new_img = img[extTop[1]:extBot[1], extLeft[0]:extRight[0]]
    else:
        new_img = img 

    # 2. Resize gi·ªØ t·ª∑ l·ªá (Padding)
    desired_size = 128
    old_size = new_img.shape[:2]
    ratio = float(desired_size)/max(old_size)
    new_size = tuple([int(x*ratio) for x in old_size])
    new_img = cv2.resize(new_img, (new_size[1], new_size[0]))
    
    delta_w = desired_size - new_size[1]
    delta_h = desired_size - new_size[0]
    top, bottom = delta_h//2, delta_h-(delta_h//2)
    left, right = delta_w//2, delta_w-(delta_w//2)
    
    color = [0, 0, 0]
    new_img = cv2.copyMakeBorder(new_img, top, bottom, left, right, cv2.BORDER_CONSTANT, value=color)
    
    return new_img

# --- 3. CHU·∫®N B·ªä ---
if not os.path.exists(OUTPUT_FOLDER):
    os.makedirs(OUTPUT_FOLDER)
    print(f"üìÇ ƒê√£ t·∫°o folder k·∫øt qu·∫£: {OUTPUT_FOLDER}")
else:
    print(f"üìÇ Folder k·∫øt qu·∫£: {OUTPUT_FOLDER}")

# Load model
print("üîÑ ƒêang load model PRO...")
try:
    model = tf.keras.models.load_model(MODEL_PATH)
    print("‚úÖ Load model th√†nh c√¥ng!")
except Exception as e:
    print(f"‚ùå L·ªói load model: {e}")
    exit()

# L·∫•y danh s√°ch ·∫£nh
all_files = os.listdir(FOLDER_YES)
image_files = [f for f in all_files if f.lower().endswith(('.png', '.jpg', '.jpeg'))]
total_img = len(image_files)

print(f"üìä T·ªïng s·ªë ·∫£nh YES c·∫ßn ki·ªÉm tra: {total_img} ·∫£nh")
print("-" * 50)

# --- 4. B·∫ÆT ƒê·∫¶U QU√âT ---
sai_so = 0
danh_sach_sai = []

for filename in tqdm(image_files, desc="Dang quet YES (Model PRO)..."):
    try:
        img_path = os.path.join(FOLDER_YES, filename)

        # A. ƒê·ªçc ·∫£nh M√ÄU (Quan tr·ªçng: Model m·ªõi d√πng 3 k√™nh m√†u)
        img_bgr = cv2.imread(img_path)
        if img_bgr is None: continue
        img_rgb = cv2.cvtColor(img_bgr, cv2.COLOR_BGR2RGB) # Chuy·ªÉn sang RGB

        # B. G·ªçi h√†m x·ª≠ l√Ω x·ªãn (C·∫Øt s·ªç + Padding)
        img_processed = ham_xu_ly_xin(img_rgb)

        # C. Chu·∫©n h√≥a v·ªÅ 0-1 (Chia cho 255.0)
        img_input = img_processed.astype('float32') / 255.0

        # D. Th√™m chi·ªÅu batch (1, 128, 128, 3)
        img_tensor = np.expand_dims(img_input, axis=0)

        # E. D·ª± ƒëo√°n
        pred = model.predict(img_tensor, verbose=0)
        score = pred[0][0]

        # --- LOGIC KI·ªÇM TRA ---
        # ·∫¢nh g·ªëc l√† YES, n√™n n·∫øu Score <= THRESHOLD (AI b·∫£o NO) th√¨ l√† SAI (B·ªè s√≥t)
        if score <= THRESHOLD:
            sai_so += 1
            confidence = (1 - score) * 100 # ƒê·ªô tin c·∫≠y c·ªßa vi·ªác ph√°n sai

            danh_sach_sai.append(f"{filename} (AI tin l√† NO: {confidence:.2f}%)")

            # Copy ·∫£nh sai ra folder
            dst_path = os.path.join(OUTPUT_FOLDER, f"MISS_{filename}")
            shutil.copy(img_path, dst_path)

    except Exception as e:
        print(f"L·ªói file {filename}: {e}")

# --- 5. B√ÅO C√ÅO ---
print("\n" + "="*50)
print(f"üèÅ ƒê√É HO√ÄN TH√ÄNH QU√âT V·ªöI MODEL PRO!")
print(f"‚ùå S·ªë ·∫£nh C√ì U m√† AI b·ªè s√≥t: {sai_so} / {total_img}")
print(f"üìâ T·ª∑ l·ªá b·ªè s√≥t: {(sai_so/total_img)*100:.2f}%")
print(f"üìÇ Xem c√°c ca b·ªã s√≥t t·∫°i:\n   {OUTPUT_FOLDER}")
print("="*50)

if sai_so > 0:
    print("Top 10 ca b·ªã b·ªè s√≥t:")
    for f in danh_sach_sai[:10]:
        print(f" - {f}")